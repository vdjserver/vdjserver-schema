#
# Schema definitions for VDJServer objects
#
# VDJServer Analysis Portal
# VDJServer Schema
# https://vdjserver.org
#
# Copyright (C) 2023 The University of Texas Southwestern Medical Center
#
# Author: Scott Christley <scott.christley@utsouthwestern.edu>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

Info:
    title: VDJServer Schema
    description: Schema definitions for VDJServer standards objects
    version: "2.0"
    contact:
        name: VDJServer
        url: https://vdjserver.org
    license:
        name: GNU Affero General Public License V3
        url: https://www.gnu.org/licenses/agpl-3.0.en.html
        copyright: UT Southwestern Medical Center

###################################################
#
# Data objects
#
###################################################

UserAccount:
  description: User account.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - username
    - password
    - email
  properties:
    username:
      type: string
    password:
      type: string
      nullable: true
    email:
      type: string
    firstName:
      type: string
    lastName:
      type: string
    city:
      type: string
    state:
      type: string
    country:
      type: string
    affiliation:
      type: string

#
# Objects for management of AIRR Data Commons
#
ADCRepositorySet:
  description: Set of ADC repositories.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - adc
  properties:
    adc:
      type: object


# VDJServer extensions for AIRR objects
#
# The schema for AIRR standards objects is extended to
# provide a number of VDJServer common properties. This schema 
# specifies the structure, property names and data types.

CommonExtension:
  discriminator:
    propertyName: VDJServer
  description: VDJServer common extension properties
  type: object
  properties:
    vdjserver_uuid:
      description: link to object in Tapis Meta
      type: string
    version:
      description: Timestamp of the object
      type: string
      format: date-time

StudyExtension:
  discriminator:
    propertyName: VDJServer
  type: object
  allOf:
    - $ref: '#/CommonExtension'
    - description: VDJServer extension properties for AIRR Study
      type: object
      properties:
        owner:
          description: Username that owns the project.
          type: string

Study:
  description: VDJServer Study which is an extension of the AIRR Study object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: 'https://raw.githubusercontent.com/airr-community/airr-standards/v1.4.1/specs/airr-schema-openapi3.yaml#/Study'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        vdjserver:
          $ref: '#/StudyExtension'

Project:
  description: VDJServer project which is an extension of the VDJServer Study object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/Study'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        vdjserver:
          $ref: '#/StudyExtension'

RepertoireExtension:
  discriminator:
    propertyName: VDJServer
  type: object
  allOf:
    - $ref: '#/CommonExtension'
    - description: VDJServer extension properties for AIRR Repertoire
      type: object
      properties:
        owner:
          description: Username that owns the project.
          type: string

Repertoire:
  description: VDJServer extension of the AIRR Repertoire object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: 'https://raw.githubusercontent.com/airr-community/airr-standards/v1.4.1/specs/airr-schema-openapi3.yaml#/Repertoire'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        vdjserver:
          $ref: '#/RepertoireExtension'

DataFileExtension:
  discriminator:
    propertyName: VDJServer
  type: object
  allOf:
    - description: VDJServer extension of AIRR DataFile
      type: object
      properties:
        "vdjserver:app:igblast":
          description: Username that owns the project.
          type: string

DataFile:
  description: VDJServer DataFile which is an extension of the AIRR DataFile object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: 'https://raw.githubusercontent.com/airr-community/airr-standards/v1.4.1/specs/airr-schema-openapi3.yaml#/DataFile'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        VDJServer:
          $ref: '#/DataFileExtension'

# Generic Tapis Meta API object
# everything except value which is customized for each object type
TapisMetaObject:
  description: Tapis Meta API object.
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    uuid:
      description: object identifier
      type: string
      nullable: false
      default: ""
    associationIds:
      description: object associations
      type: array
      nullable: true
      items:
        type: string
    owner:
      description: Tapis object owner
      type: string
      nullable: true
    created:
      description: object creation timestamp
      type: string
      format: date-time
      nullable: true
    lastUpdated:
      description: object last update timestamp
      type: string
      format: date-time
      nullable: true
    name:
      description: object type name
      type: string
      nullable: false
#    value:
#      description: object value, can be a nested JSON object
#      type: object
#      nullable: false

ProjectMetadata:
  description: Tapis Meta object for a project.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: VDJServer project.
      type: object
      properties:
        value:
          $ref: '#/Project'

RepertoireMetadata:
  description: VDJServer Repertoire in normal form, just vdjserver uuids link them
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    study:
      type: object
      properties:
        vdjserver:
          $ref: '#/CommonExtension'
    subject:
      type: object
      properties:
        vdjserver:
          $ref: '#/CommonExtension'
    sample:
      type: array
      items:
        type: object
        properties:
          vdjserver:
            $ref: '#/CommonExtension'
    data_processing:
      type: array
      items:
        type: object
        properties:
          vdjserver:
            $ref: '#/CommonExtension'

ProvDocument:
  description: PROV document
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: prov_document
  properties:
    entity:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/entity'
    agent:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/agent'
    activity:
      type: object
      properties:
        "prov:startTime":
          type: string
          format: date-time
        "prov:endTime":
          type: string
          format: date-time
      additionalProperties:
        $ref: "https://www.w3.org/Submission/prov-json/schema#/definitions/attributeValues"
    used:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/usage'
    wasAttributedTo:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/attribution'
    wasAssociatedWith:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/association'
    wasDerivedFrom:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/derivation'
    wasGeneratedBy:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/generation'

TaskDocument:
  description: PROV document
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    uses:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/usage'
    isAttributedTo:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/attribution'
    isAssociatedWith:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/association'
    isDerivedFrom:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/derivation'
    isGeneratedBy:
      $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/generation'

AnalysisDocument:
  description: VDJServer analysis workflow document
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: analysis_document
  allOf:
    - $ref: '#/ProvDocument'
    - $ref: '#/TaskDocument'

PROVModel:
  description: PROV model
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: prov_model
  properties:
    prefix:
      description: namespace prefixes
      type: object
      nullable: true
    entity:
      description: Set of entities.
      type: object
      nullable: true
    agent:
      description: Set of agents.
      type: object
      nullable: true
    activity:
      description: Set of activities.
      type: object
      nullable: true
    used:
      description: relationship; activity used entity.
      type: object
      nullable: true
    wasAttributedTo:
      description: relationship; X wasAttributedTo agent.
      type: object
      nullable: true
    wasAssociatedWith:
      description: relationship; X wasAssociatedWith Y.
      type: object
      nullable: true
    wasDerivedFrom:
      description: relationship; entity wasDerivedFrom entity.
      type: object
      nullable: true
    wasGeneratedBy:
      description: relationship; entity wasGeneratedBy activity.
      type: object
      nullable: true

###################################################
#
# Web API objects for requests and responses
#
###################################################

BasicResponse:
    description: Basic response object
    discriminator:
        propertyName: VDJServer
    type: object
    properties:
        status:
            type: boolean
        message:
            type: string

InfoObject:
  description: Provides information about the API service and/or response
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    title:
      type: string
    version:
      type: string
    description:
      type: string
    contact: 
      type: object
      properties:
        name:
          type: string
        url:
          type: string
        email:
          type: string
    license:
      type: object
      properties:
        name:
          type: string
        url:
          type: string
        copyright:
          type: string

Recaptcha:
  description: Google recaptcha response.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - g-recaptcha-response
  properties:
    g-recaptcha-response:
      type: string
      description: The recaptcha response

UserAccountCreation:
  description: Account creation with user and recaptcha objects
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/UserAccount'
    - $ref: '#/Recaptcha'

ProjectPermission:
  description: Permissions request for project
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - project_uuid
  properties:
    project_uuid:
      description: project related to the permissions.
      type: string

UserPermission:
  description: Permissions request for user
  discriminator:
    propertyName: VDJServer
  required:
    - username
  allOf:
    - $ref: '#/ProjectPermission'
    - type: object
      properties:
        username:
          description: user to apply permissions
          type: string

MetadataPermission:
  description: Permissions request for project metadata object
  discriminator:
    propertyName: VDJServer
  required:
    - metadata_uuid
  allOf:
    - $ref: '#/ProjectPermission'
    - type: object
      properties:
        metadata_uuid:
          description: metadata object to apply permissions
          type: string

Feedback:
  description: Feedback message.
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    feedback:
      type: string
      description: message content

PublicFeedback:
  description: Public feedback message.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/Feedback'
    - $ref: '#/Recaptcha'
    - type: object
      properties:
        email:
          description: User email.
          type: string

ErrorTelemetry:
  description: Error telemetry.
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    project_uuid:
      type: string
    job_uuid:
      type: string
    filename:
      type: string
    method:
      type: string
    error:
      type: string
    view:
      type: string
    browser:
      type: string
    os:
      type: string


PROVRequest:
  description: Request execution of a PROV model
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: prov_request
  properties:
    prov_model:
      $ref: '#/PROVModel'
    audit_only:
      description: Runs through full model to validate, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true

AIRRDataCommons:
  description: VDJServer object to represent the whole AIRR Data Commons (ADC), which includes VDJServer.
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: airr_data_commons
  properties:
    prov_model:
      $ref: '#/PROVModel'
    audit_only:
      description: Runs through full model to validate, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true

ADCRepository:
  description: VDJServer object to represent an ADC repository, this includes VDJServer.
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: adc_repository
  properties:
    prov_model:
      $ref: '#/PROVModel'
    audit_only:
      description: Runs through full model to validate, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true

ADCCache:
  description: VDJServer object to represent the cache of the ADC, which includes VDJServer itself.
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: adc_cache
  properties:
    prov_model:
      $ref: '#/PROVModel'
    audit_only:
      description: Runs through full model to validate, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true















