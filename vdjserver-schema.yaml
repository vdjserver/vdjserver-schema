#
# Schema definitions for VDJServer objects
#
# VDJServer Analysis Portal
# VDJServer Schema
# https://vdjserver.org
#
# Copyright (C) 2023 The University of Texas Southwestern Medical Center
#
# Author: Scott Christley <scott.christley@utsouthwestern.edu>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

Info:
    title: VDJServer Schema
    description: Schema definitions for VDJServer standards objects
    version: "2.0"
    contact:
        name: VDJServer
        url: https://vdjserver.org
    license:
        name: GNU Affero General Public License V3
        url: https://www.gnu.org/licenses/agpl-3.0.en.html
        copyright: UT Southwestern Medical Center

###################################################
#
# Data objects
#
###################################################

UserAccount:
  description: User account.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - username
    - password
    - email
  properties:
    username:
      type: string
    password:
      type: string
      nullable: true
    email:
      type: string
    firstName:
      type: string
    lastName:
      type: string
    city:
      type: string
    state:
      type: string
    country:
      type: string
    affiliation:
      type: string

#
# Objects for management of AIRR Data Commons
#
ADCRepository:
  description: VDJServer object to represent an ADC repository, this includes VDJServer.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - repository_id
    - title
    - server_host
    - base_url
  properties:
    repository_id:
      description: Unique repository identifier
      example: vdjserver
      type: string
      nullable: false
    disable:
      description: Disable the repository
      type: boolean
      default: true
    title:
      description: Display name of repository
      example: VDJServer
      type: string
    server_host:
      description: Hostname for repository
      example: vdjserver.org
      type: string
      nullable: false
    base_url:
      description: Base ADC URL for repository
      example: /airr/v1
      type: string
      nullable: false
    enable_cache:
      description: ADC download caching for the repository
      type: boolean
      default: false
    supports_async:
      description: Repository supports AIRR ADC ASYNC API extension
      type: boolean
      default: false
    async_host:
      description: Hostname for repository
      example: vdjserver.org
      type: string
    async_base_url:
      description: Base ADC ASYNC API URL for repository
      example: /airr/async/v1
      type: string
      nullable: false
    enable_statistics_cache:
      description: Statistics cache enable/disable for the repository
      type: boolean
      default: false

ADCRepositorySet:
  description: Set of ADC repositories.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - adc
  properties:
    adc:
      description: List of production repositories. Each entry is keyed by the repository id.
      type: object
      additionalProperties:
        $ref: "#/ADCRepository"
    staging:
      description: List of staging repositories. Each entry is keyed by the repository id.
      type: object
      additionalProperties:
        $ref: "#/ADCRepository"

#
# ADC project load objects
#
ADCProjectLoad:
  description: ADC project load.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - collection
  properties:
    collection:
      description: Collection suffix.
      type: string
      nullable: false
    shouldLoad:
      description: Flag to indicate project should be loaded into ADC.
      type: boolean
      default: false
    isLoaded:
      description: Flag to indicate project is completely loaded into ADC.
      type: boolean
      default: false
    repertoireMetadataLoaded:
      description: Flag to indicate if repertoire data has finished loading into ADC.
      type: boolean
      default: false
    rearrangementDataLoaded:
      description: Flag to indicate if rearrangement data has finished loading into ADC.
      type: boolean
      default: false

ADCRearrangementLoad:
  description: ADC rearrangement load.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - repertoire_id
    - collection
  properties:
    repertoire_id:
      description: Repertoire identifier for the rearrangements.
      type: string
      nullable: false
    collection:
      description: Collection suffix.
      type: string
      nullable: false
    isLoaded:
      description: Flag to indicate rearrangements are completely loaded into ADC.
      type: boolean
      default: false
    load_set:
      description: Last rearrangement set that was loaded.
      type: number

#
# ADC download cache objects
#
ADCDownloadCache:
  description: ADC download cache status.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - enable_cache
  properties:
    enable_cache:
      description: Global enable/disable of the cache. Local settings for a service may override this.
      type: boolean
      default: false

ADCDownloadCacheStudy:
  description: ADC download cache status for a study in a repository
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - repository_id
    - study_id
  properties:
    repository_id:
      description: Repository identifier
      example: vdjserver
      type: string
      nullable: false
    study_id:
      description: Study identifier
      example: PRJNA578389
      type: string
      nullable: false
    should_cache:
      description: Flag to enable/disable caching of this study.
      type: boolean
      default: false
    is_cached:
      description: Is this study cached.
      type: boolean
      default: false
    archive_file:
      description: File path to the cached study
      type: string
    download_url:
      description: Tapis Postits public URL to download cache file
      type: string

ADCDownloadCacheRepertoire:
  description: ADC download cache status for a repertoire within a study
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - repository_id
    - study_id
    - repertoire_id
  properties:
    repository_id:
      description: Repository identifier
      example: vdjserver
      type: string
      nullable: false
    study_id:
      description: Study identifier
      example: PRJNA578389
      type: string
      nullable: false
    repertoire_id:
      description: Repertoire identifier
      example: vdjserver
      type: string
      nullable: false
    should_cache:
      description: Flag to enable/disable caching of this repertoire.
      type: boolean
      default: false
    is_cached:
      description: Is this repertoire cached.
      type: boolean
      default: false
    archive_file:
      description: File path to the cached repertoire
      type: string
    download_url:
      description: Tapis Postits public URL to download cache file
      type: string

# VDJServer extensions for AIRR objects
#
# The schema for AIRR standards objects is extended to
# provide a number of VDJServer common properties. This schema 
# specifies the structure, property names and data types.

CommonExtension:
  discriminator:
    propertyName: VDJServer
  description: VDJServer common extension properties
  type: object
  properties:
    vdjserver_uuid:
      description: link to object in Tapis Meta
      type: string
    version:
      description: Timestamp of the object
      type: string
      format: date-time

StudyExtension:
  discriminator:
    propertyName: VDJServer
  type: object
  allOf:
    - $ref: '#/CommonExtension'
    - description: VDJServer extension properties for AIRR Study
      type: object
      properties:
        owner:
          description: Username that owns the project.
          type: string

Study:
  description: VDJServer Study which is an extension of the AIRR Study object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: 'https://raw.githubusercontent.com/airr-community/airr-standards/v1.4.1/specs/airr-schema-openapi3.yaml#/Study'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        vdjserver:
          $ref: '#/StudyExtension'

Project:
  description: VDJServer project which is an extension of the VDJServer Study object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/Study'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        vdjserver:
          $ref: '#/StudyExtension'

RepertoireExtension:
  discriminator:
    propertyName: VDJServer
  type: object
  allOf:
    - $ref: '#/CommonExtension'
    - description: VDJServer extension properties for AIRR Repertoire
      type: object
      properties:
        owner:
          description: Username that owns the project.
          type: string

Repertoire:
  description: VDJServer extension of the AIRR Repertoire object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: 'https://raw.githubusercontent.com/airr-community/airr-standards/v1.4.1/specs/airr-schema-openapi3.yaml#/Repertoire'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        vdjserver:
          $ref: '#/RepertoireExtension'

DataFileExtension:
  discriminator:
    propertyName: VDJServer
  type: object
  allOf:
    - description: VDJServer extension of AIRR DataFile
      type: object
      properties:
        "vdjserver:app:igblast":
          description: Username that owns the project.
          type: string

DataFile:
  description: VDJServer DataFile which is an extension of the AIRR DataFile object.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: 'https://raw.githubusercontent.com/airr-community/airr-standards/v1.4.1/specs/airr-schema-openapi3.yaml#/DataFile'
    - description: VDJServer object container for extra attributes.
      type: object
      properties:
        VDJServer:
          $ref: '#/DataFileExtension'

# Generic Tapis Meta API object
# everything except value which is customized for each object type
TapisMetaObject:
  description: Tapis Meta API object.
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    uuid:
      description: object identifier
      type: string
      nullable: false
      default: ""
    associationIds:
      description: object associations
      type: array
      nullable: true
      items:
        type: string
    owner:
      description: Tapis object owner
      type: string
      nullable: true
    created:
      description: object creation timestamp
      type: string
      format: date-time
      nullable: true
    lastUpdated:
      description: object last update timestamp
      type: string
      format: date-time
      nullable: true
    name:
      description: object type name
      type: string
      nullable: false
#    value:
#      description: object value, can be a nested JSON object
#      type: object
#      nullable: false

ProjectMetadata:
  description: Tapis Meta object for a project.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: VDJServer project.
      type: object
      properties:
        value:
          $ref: '#/Project'

RepertoireMetadata:
  description: VDJServer Repertoire in normal form, just vdjserver uuids link them
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    study:
      type: object
      properties:
        vdjserver:
          $ref: '#/CommonExtension'
    subject:
      type: object
      properties:
        vdjserver:
          $ref: '#/CommonExtension'
    sample:
      type: array
      items:
        type: object
        properties:
          vdjserver:
            $ref: '#/CommonExtension'
    data_processing:
      type: array
      items:
        type: object
        properties:
          vdjserver:
            $ref: '#/CommonExtension'

ADCRepositorySetMeta:
  description: Tapis Meta object.
  discriminator:
    propertyName: VDJServer
  x-vdjserver:
    tapis_name: adc_system_repositories
    singleton: true
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: VDJServer project.
      type: object
      properties:
        value:
          $ref: '#/ADCRepositorySet'

ADCProjectLoadMeta:
  description: Tapis Meta object.
  discriminator:
    propertyName: VDJServer
  x-vdjserver:
    tapis_name: projectLoad
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: Project load into ADC.
      type: object
      properties:
        value:
          $ref: '#/ADCProjectLoad'

ADCRearrangementLoadMeta:
  description: Tapis Meta object.
  discriminator:
    propertyName: VDJServer
  x-vdjserver:
    tapis_name: rearrangementLoad
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: Load rearrangements for project into ADC.
      type: object
      properties:
        value:
          $ref: '#/ADCRearrangementLoad'

ADCDownloadCacheMeta:
  description: Tapis Meta object.
  discriminator:
    propertyName: VDJServer
  x-vdjserver:
    tapis_name: adc_cache
    singleton: true
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: ADC download cache for study.
      type: object
      properties:
        value:
          $ref: '#/ADCDownloadCache'

ADCDownloadCacheStudyMeta:
  description: Tapis Meta object.
  discriminator:
    propertyName: VDJServer
  x-vdjserver:
    tapis_name: adc_cache_study
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: ADC download cache for study.
      type: object
      properties:
        value:
          $ref: '#/ADCDownloadCacheStudy'

ADCDownloadCacheRepertoireMeta:
  description: Tapis Meta object.
  discriminator:
    propertyName: VDJServer
  x-vdjserver:
    tapis_name: adc_cache_repertoire
  allOf:
    - $ref: '#/TapisMetaObject'
    - description: ADC download cache for repertoire.
      type: object
      properties:
        value:
          $ref: '#/ADCDownloadCacheRepertoire'

ProvDocument:
  description: PROV document
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: prov_document
  properties:
    entity:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/entity'
    agent:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/agent'
    activity:
      additionalProperties:
        type: object
        properties:
          "prov:startTime":
            type: string
            format: date-time
          "prov:endTime":
            type: string
            format: date-time
        additionalProperties:
          $ref: "https://www.w3.org/Submission/prov-json/schema#/definitions/attributeValues"
    used:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/usage'
    wasAttributedTo:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/attribution'
    wasAssociatedWith:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/association'
    wasDerivedFrom:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/derivation'
    wasGeneratedBy:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/generation'

TaskDocument:
  description: Task document
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    uses:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/usage'
    isAttributedTo:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/attribution'
    isAssociatedWith:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/association'
    isDerivedFrom:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/derivation'
    isGeneratedBy:
      additionalProperties:
        $ref: 'https://www.w3.org/Submission/prov-json/schema#/definitions/generation'

AnalysisDocument:
  description: Analysis workflow document
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: analysis_document
  allOf:
    - $ref: '#/ProvDocument'
    - $ref: '#/TaskDocument'

###################################################
#
# Web API objects for requests and responses
#
###################################################

BasicResponse:
    description: Basic response object
    discriminator:
        propertyName: VDJServer
    type: object
    properties:
        status:
            type: boolean
        message:
            type: string

InfoObject:
  description: Provides information about the API service and/or response
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    title:
      type: string
    version:
      type: string
    description:
      type: string
    contact: 
      type: object
      properties:
        name:
          type: string
        url:
          type: string
        email:
          type: string
    license:
      type: object
      properties:
        name:
          type: string
        url:
          type: string
        copyright:
          type: string

Recaptcha:
  description: Google recaptcha response.
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - g-recaptcha-response
  properties:
    g-recaptcha-response:
      type: string
      description: The recaptcha response

UserAccountCreation:
  description: Account creation with user and recaptcha objects
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/UserAccount'
    - $ref: '#/Recaptcha'

ProjectPermission:
  description: Permissions request for project
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - project_uuid
  properties:
    project_uuid:
      description: project related to the permissions.
      type: string

UserPermission:
  description: Permissions request for user
  discriminator:
    propertyName: VDJServer
  required:
    - username
  allOf:
    - $ref: '#/ProjectPermission'
    - type: object
      properties:
        username:
          description: user to apply permissions
          type: string

MetadataPermission:
  description: Permissions request for project metadata object
  discriminator:
    propertyName: VDJServer
  required:
    - metadata_uuid
  allOf:
    - $ref: '#/ProjectPermission'
    - type: object
      properties:
        metadata_uuid:
          description: metadata object to apply permissions
          type: string

Feedback:
  description: Feedback message.
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    feedback:
      type: string
      description: message content

PublicFeedback:
  description: Public feedback message.
  discriminator:
    propertyName: VDJServer
  allOf:
    - $ref: '#/Feedback'
    - $ref: '#/Recaptcha'
    - type: object
      properties:
        email:
          description: User email.
          type: string

ErrorTelemetry:
  description: Error telemetry.
  discriminator:
    propertyName: VDJServer
  type: object
  properties:
    project_uuid:
      type: string
    job_uuid:
      type: string
    filename:
      type: string
    method:
      type: string
    error:
      type: string
    view:
      type: string
    browser:
      type: string
    os:
      type: string


AnalysisRequest:
  description: Request execution of an analysis workflow
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: analysis_request
  required:
    - workflow
  properties:
    workflow:
      $ref: '#/AnalysisDocument'
    audit_only:
      description: Simulates execution of workflow for validation, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true

AIRRDataCommons:
  description: VDJServer object to represent the whole AIRR Data Commons (ADC), which includes VDJServer.
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: airr_data_commons
  properties:
    audit_only:
      description: Runs through full model to validate, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true

ADCCache:
  description: VDJServer object to represent the cache of the ADC, which includes VDJServer itself.
  discriminator:
    propertyName: VDJServer
  type: object
  x-vdjserver:
    tapis_name: adc_cache
  properties:
    audit_only:
      description: Runs through full model to validate, assumes jobs run correctly but does not execute them.
      type: boolean
      nullable: true
    use_alternate_app:
      description: If exact Tapis app is not available because execution system is unavailable, try similar app on another execution system.
      type: boolean
      nullable: true

ADCRepositoryUpdateRequest:
  description: API request object
  discriminator:
    propertyName: VDJServer
  type: object
  required:
    - repository_set
    - repository
  properties:
    repository_set:
      type: string
    repository:
      $ref: '#/ADCRepository'














